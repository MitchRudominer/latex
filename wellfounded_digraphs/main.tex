\documentclass[oneside,12pt]{amsart}

\usepackage{amsmath,amssymb,latexsym,eucal,amsthm,graphicx}

\input{mathdefs}
\input{theoremstyles}

\pagestyle{plain}

\begin{document}

\title{Well-Founded Two-Sorted Directed Graphs}
\author{Mitch Rudominer}
\address{Google}
\email{rudominer@google.com}

\keywords{graph theory, programming languages, compilers}

\begin{abstract}
We introduce a generalization of the notion of a directed acyclic  graph:
a \emph{well-founded} two-sorted graph. We study the
property of well-foundedness and describe an algorithm for verifying it.

Our two-sorted graphs include two sorts of nodes: regular nodes
nodes called \emph{circle} nodes, and special nodes called \emph{square} nodes.
What makes a square node special is that rather than requiring that all
out-edges may be followed to eventually reach a leaf node (this is the
case with a regular acyclic digraph) we only require that at least one
of its out-edges have this property.

A regular digraph (that is a digraph with only regular circle nodes) is
well-founded if and only if it is acyclic. But a digraph that contains square
nodes may be well-founded and still contain some cycles that involve square
nodes.

We present one application of this theory: The analysis of the validity of
user-defined types in a programming language that includes user-defined structs and unions.
The structs are modeled as circle nodes and the unions are modelled as square
nodes. The well-foundedness of the type graph coincides with the validity
of the definition of a compound user-defined type built up from structs and unions.
\end{abstract}

\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Square-Imposed Subgraphs}

\begin{definition}
Let $x$ be a node in a directed graph $G$. Then the subgraph of $G$ \emph{rooted at} $x$,
denoted $G_x$, is the subgraph of $G$ generated by all edges reachable from $x$.
\end{definition}

\begin{definition}
Let $x$ and $y$ be nodes in a directed graph and suppose there is an edge from
$x$ to $y$. Then we will say that $y$ is a \emph{child} of $x$ and that $x$ is a
\emph{parent} of $y$.
\end{definition}

Notice that with the above two definitions we are for convenience abusing some terminology that is
more appropriately applied in the case of a tree. In case of a general digraph the child
relationship is not asymmetric and in particular a node may be its own parent. Also
$G_x = G_y$ iff $x$ and $y$ are reachable from each other.

\begin{definition}
A \emph{two-sorted graph} is a directed graph in which the nodes are of two sorts
that we call \emph{circle} nodes and \emph{square} nodes.
\end{definition}

\begin{definition}
Let $G$ be a two-sorted graph and let $H$ be a subgraph of $G$. Then we say that
$H$ is \emph{square-imposed} iff
\begin{enumerate}
\item Every node of $G$ is a node of $H$.
\item If $x$ is a circle node of $G$ then every out-edge from $x$ is in $H$.
\item If $x$ is a square node of $G$ and if $x$ has at least one out-edge
in $G$ then $x$ has at least one out-edge in $H$.
\end{enumerate}

Thus a square-imposed subgraph is one in which the square nodes get to impose
which of their out edges they choose to throw away, subject to the constraint that
they must keep at least one. A circle node gets to make
no choices: all of its out-edges must be kept. 

Notice that if $G$ is a regular digraph (that is $G$ has only circle nodes) then it
has no proper square-imposed subgraphs.

\begin{definition}
Let $G$ be a two-sorted graph. We say that $G$ is \emph{acceptable} iff $G$ has
an acyclic square-imposed subgraph. Let $x$ be a node of $G$. We say that $x$ is
acceptable iff $G_x$ is acceptable.
\end{definition}

So a regular digraph is acceptable iff it is acyclic. Figure 1 below shows an acceptable graph $G$ on the left
and $H$, an acyclic square-imposed subgraph of $G$, on the right.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{fig1.jpg}
    \caption{H is an acyclic square-imposed subgraph of G}
    \label{fig:fig1}
\end{figure}

\begin{theorem}
\label{Acceptability-Is-Local}
The following are equivalent.
\begin{enumerate}
\item $G$ is acceptable
\item Every node of $G$ is acceptable.
\end{enumerate}
\end{theorem}

The proof of (1) $\Implies$ (2) is easy:  An acyclic square-imposed subgraph of $G$
yields an acyclic square-imposed subgraph of $G_x$. The proof of (2) $\Implies$ (1)
is trickier because if one naively attempts to piece together a bunch of acyclic square-imposed
subgraphs the resulting larger graph need not be acyclic. We will prove this theorem in a later section.

\end{definition}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Well-Founded Nodes}

In this section we give a bottom-up definition that turns out to be equivalent to the top-down
notion of acceptability given in the previous section.

We wish to define the notion of a node in a two-sorted graph being \emph{well-founded.} The following recursive property
is easy to understand and it is tempting to make it the definition of well-founded.

\begin{itemize}
\item A leaf node (i.e. a node without any children) is well-founded.
\item A circle node is well-founded iff all of its children are well-founded.
\item A non-leaf square node is well-founded iff at least one of its children are well-founded.
\end{itemize}

This recursion will turn out to be valid. However it is not logically correct to use the above clauses as the
definition of well-foundedness. This is because definition by recursion may only be done with respect to
a well-founded relation. The clauses above are expressed using recursion on the \emph{child} relation and this
relation is not well-founded in a digraph with cycles. Instead we give the following more formal definition
of the \emph{rank} of a node in a two-sorted graph.

\begin{definition}
Let $x$ be a node in a two-sorted graph. Then we say $\rank(x) = 0$ iff $x$ is a leaf node.
Let $n\geq 0$. We say that $\rank(x) = n+1$ iff
\begin{itemize}
\item $x$ is a circle node and for all children $y$ of $x$, $\rank(y)$ is defined and $\rank(y) <= n$ and for at least one child
$y$, $\rank(y)=n$, or
\item $x$ is a square node and it has a child $y$ such that $\rank(y) = n$ and it does not have a child
$y$ such that $\rank(y) < n$.
\end{itemize}
\end{definition}

A more concise but arguably less clear way of expressing the two bullet points in the above definition is:

\begin{itemize}
\item $x$ is a circle node and $n$ is least such that all children of $x$ have rank $\leq n$, or
\item $x$ is a square node and $n$ is least such that there exists a child of $x$ with rank $\leq n$.
\end{itemize}

\begin{definition}
Let $x$ be a node in a two-sorted graph. Then $x$ is \emph{well-founded} iff it has a rank.
\end{definition}

Unlike the informal definition of well-founded we gave above, this definition is logically sound because
the definition of the rank function proceeds by induction on the integers. The informal definition may now
be expressed properly as a lemma:

\begin{lemma}
\label{SimpleDefOfWF}
Let $x$ be a node in a two-sorted graph $G$.  Then $x$ is well-founded iff
\begin{enumerate}
\item $x$ is a leaf node, or
\item $x$ is a circle node and all children of $x$ are well-founded, or
\item $x$ is a square node and at least one child of $x$ is well-founded.
\end{enumerate}
\end{lemma}
\begin{proof}
First assume that $x$ is well-founded. If $\rank(x) = 0$ then (a) holds.
If $\rank(x) > 0$ then by the definition of rank if $x$ is a circle node then (b)
holds and if $x$ is a square node then (c) holds.

Conversely if (a) holds then $\rank(x) = 0$. If (b) holds then letting $n$ be
the maximum rank of any child of $x$, $\rank(x) = n+1$. If (c) holds then letting
$n$ be the minimum rank of any child of $x$, $\rank(x) = n+1$. So if (a), (b) or (c)
holds then $x$ has a rank and is therefore well-founded.
\end{proof}

\begin{lemma}
\label{WellFoundedIsLocal}
Let $x$ be a node in a two-sorted graph $G$ and let $y$ be a node in $G_x$.
Then $y$ is well-founded as a node in $G$
iff $y$ is well-founded as a node in $G_x$.
\end{lemma}
\begin{proof}
We prove by induction on $n$ that for all nodes $y$ of $G_x$, $\rank(y) = n$  in $G$
iff $\rank(y) = n$  in $G_x$. For $n=0$ this just means that $y$ is a leaf of $G$ iff
$y$ is a leaf of $G_x$. This is true since $G_x$ is closed under reachability. For
$n>0$ this is true by induction since $y$ has the same children in $G$ as it has
in $G_x$.
\end{proof}

Now we can relate the bottom-up notion of well-foundedness to the top-down notion of acceptabilty.


\begin{theorem}
\label{MainEquivalence}
Let $G$ be a two-sorted graph. Then the following are equivalent:
\begin{enumerate}
\item $G$ is acceptable
\item Every node of $G$ is well-founded.
\end{enumerate}
\end{theorem}
\begin{proof}
First assume (1). Let $H$ be an acyclic, square-imposed subgraph of $G$. Since $H$ is acyclic, the
relation $<$ on the nodes of $H$ defined by $x<y$ iff $x$ is reachable from $y$
is a well-founded partial order, meaning that it is asymmetric,
transitive, and has no infinite descending chains. This allows us to perform induction on it.
Recall that $H$ and $G$ have the same set of nodes.
We prove by induction on $<$ that every node of $H$ is well-founded (as a node in $G$).
We use the characterization of well-founded nodes given by Lemma \ref{SimpleDefOfWF}.
Let $x$ be a non-leaf node.
By induction on $<$, every child of $x$ in $H$ is well-founded in $G$.
If $x$ is a circle node since $H$ is
square-imposed, every child of $x$ in $G$ is well-founded and so $x$ is well-founded.
If $x$ is a square node then again, since $H$ is square-imposed,
there is at least one child of $x$ in $G$ that is well-founded in $G$ and so $x$ is well-founded in $G$.

Conversely assume (2). Let $H$ be the following square-imposed subgraph of $G$:
For each non-leaf square node $x$ in $G$, we will pick exactly one edge $e$ originating
from $x$ and we will add $e$ to $H$. We let $e = (x, y)$ be any out-edge from $x$ to a child $y$
such that $\rank(y)<\rank(x)$. Since $x$ is well-founded, there is such a $y$ by the definition of the rank of a square node.
This $H$ is clearly square-imposed. We claim that $H$ is acyclic. For suppose
$y_0, y_1,\dots,y_n=y_0$ were a cycle in $H$. To arrive at a contradiction we will show that for each $i<n$
$\rank(y_i)>\rank(y_{i+1})$. This will be a contradiction because $y_n=y_0$. If $y_i$ is a circle node then
$\rank(y_i)>\rank(y_{i+1})$ because by the definition of the rank of a circle node $\rank(y_i)$ is greater than the
ranks of all of its children. If $y_i$ is a square node then $e=(y_i,y_{i+1} )$ is the unique out-edge from $y_i$ that
we added to $H$ and so by construction $\rank(y_i)>\rank(y_{i+1})$.
\end{proof}

Now we can give the

\begin{proof}[proof of Theorem \ref{Acceptability-Is-Local}.]
$G$ is acceptable iff every node of $G$ is well-founded (by Theorem \ref{MainEquivalence})
iff for every node $x$ of $G$ every node $y$ of $G_x$ is well-founded in $G_x$ (by Lemma \ref{WellFoundedIsLocal})
iff for every node $x$ of $G$, $G_x$ is acceptable (by Theorem \ref{MainEquivalence}.)
\end{proof}

Note that it may happen that $x$ is well-founded and $y\in G_x$ but $y$ is not well-founded. Thus it is not true
that $x$ is well-founded iff $x$ is acceptable.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{An Algorithm for Verifying Acceptability}
In this section we outline an algorithm for determining whether a two-sorted graph $G$ is acceptable.
If $G$ happens to be a regular graph (consisting of only circle nodes) then our algorithm reduces
to the usual depth-first-search algorithm for determining whether a directed graph contains a cycle.

TODO: Finish this section.

\section{An Application to Programming Languages}
In this section give an application of the theory of well-founded two-sorted graphs to the verification of the validity
of a set of user-defined types in a programming language.

TODO: Finish this section.

\end{document}